<!DOCTYPE html>

<html lang="en">

<head>
  
  <meta name="baidu-site-verification" content="code-J1Qg17G6wT" />
  <title>Dictionary底层源码剖析 - 流氓兔の窝</title>
  <meta charset="UTF-8">
  <meta name="description" content="落魄码农，在线乞讨. 来世还学Unity(哭唧唧）
">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  
  

    <!-- Site Verification -->
    <meta name="baidu-site-verification" content="code-J1Qg17G6wT" />

  <link rel="shortcut icon" href="/images/head/avatar2.jpg" type="image/png" />
  <meta name="description" content="&amp;emsp;&amp;emsp;Dictionary是C#中常用的数据结构之一，下面我们来对其进行底层源码的分析，看看常用的字典容器是如何构造的，它的优缺点如何。">
<meta property="og:type" content="article">
<meta property="og:title" content="Dictionary底层源码剖析">
<meta property="og:url" content="https://loveviolet.github.io/2022/05/03/Dictionary%E5%BA%95%E5%B1%82%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/index.html">
<meta property="og:site_name" content="流氓兔の窝">
<meta property="og:description" content="&amp;emsp;&amp;emsp;Dictionary是C#中常用的数据结构之一，下面我们来对其进行底层源码的分析，看看常用的字典容器是如何构造的，它的优缺点如何。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://loveviolet.github.io/images/Dictionary%E5%89%96%E6%9E%90/%E6%8B%89%E9%93%BE%E6%B3%95%E7%BB%93%E6%9E%84%E5%9B%BE.png">
<meta property="article:published_time" content="2022-05-03T08:00:26.000Z">
<meta property="article:modified_time" content="2023-12-01T07:16:05.723Z">
<meta property="article:author" content="色眯眯の流氓兔">
<meta property="article:tag" content="随笔 Dictionary底层代码剖析">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://loveviolet.github.io/images/Dictionary%E5%89%96%E6%9E%90/%E6%8B%89%E9%93%BE%E6%B3%95%E7%BB%93%E6%9E%84%E5%9B%BE.png">
  <link rel="stylesheet" href="https://lib.baomitu.com/highlight.js/9.15.8/styles/atom-one-dark.min.css" crossorigin>
  <link rel="stylesheet" href="/lib/mdui_043tiny/css/mdui.css">
  <link rel="stylesheet" href="/lib/iconfont/iconfont.css">
  <link rel="stylesheet" href="/lib/fancybox/css/jquery.fancybox.min.css">
  <link rel="stylesheet" href="https://lib.baomitu.com/justifiedGallery/3.8.1/css/justifiedGallery.min.css">
  
    <link rel="stylesheet" href="//at.alicdn.com/t/font_2421060_8z08qcz5sq3.css">
  
  <link rel="stylesheet" href="/css/style.css?v=1702547675474">
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="mdui-drawer-body-left">
  
  <div id="nexmoe-background">
    <div class="nexmoe-bg" style="background-image: url(/images/background/bg_01.png)"></div>
    <div class="nexmoe-small" style="background-image: url(/images/background/lihuii4.png)"></div>
    <div class="mdui-appbar mdui-shadow-0">
      <div class="mdui-toolbar">
        <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon mdui-ripple"><i class="mdui-icon nexmoefont icon-menu"></i></a>
        <div class="mdui-toolbar-spacer"></div>
        <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
        <a href="/" title="色眯眯の流氓兔" class="mdui-btn mdui-btn-icon"><img src="/images/head/avatar2.jpg" alt="色眯眯の流氓兔"></a>
       </div>
    </div>
  </div>
  <div id="nexmoe-header">
      <div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="色眯眯の流氓兔">
            <img src="/images/head/avatar2.jpg" alt="色眯眯の流氓兔" alt="色眯眯の流氓兔">
        </a>
    </div>
    <div class="nexmoe-count">
        <div class="nexmoe-count-item"><span>Articles</span>14 <div class="item-radius"></div><div class="item-radius item-right"></div> </div>
        <div class="nexmoe-count-item"><span>Tags</span>7<div class="item-radius"></div><div class="item-radius item-right"></div></div>
        <div class="nexmoe-count-item"><span>Categories</span>0<div class="item-radius"></div><div class="item-radius item-right"></div></div>
    </div>
    <div class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/about.html" title="色眯眯の流氓兔">
            <i class="mdui-list-item-icon nexmoefont icon-jiubei1"></i>
            <div class="mdui-list-item-content">
                色眯眯の流氓兔
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/" title="回到首页">
            <i class="mdui-list-item-icon nexmoefont icon-meishi"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/archives.html" title="文章归档">
            <i class="mdui-list-item-icon nexmoefont icon-hanbao1"></i>
            <div class="mdui-list-item-content">
                文章归档
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/friend.html" title="我的朋友">
            <i class="mdui-list-item-icon nexmoefont icon-cola"></i>
            <div class="mdui-list-item-content">
                我的朋友
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/download.html" title="下载中心">
            <i class="mdui-list-item-icon nexmoefont icon-tangguo"></i>
            <div class="mdui-list-item-content">
                下载中心
            </div>
        </a>
        
    </div>
    <aside id="nexmoe-sidebar">
  
  
<!-- 站内搜索 -->

<div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-search" >
        <form id="search-form">
            <label><input type="text" id="local-search-input" name="q" results="0" placeholder="站内搜索" class="input form-control" autocomplete="off" autocorrect="off"/></label>
            <!-- 清空/重置搜索框 -->
            <i class="fa fa-times" onclick="resetSearch()"></i>
        </form>
    </div>
    <div id="local-search-result"></div> <!-- 搜索结果区 -->
    <!-- <p class='no-result'></p> 无匹配时显示，注意在 CSS 中设置默认隐藏 -->
</div>


  
  <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-social">
        <a class="mdui-ripple" href="https://qm.qq.com/q/kHJsM8H876" target="_blank" mdui-tooltip="{content: 'QQ'}" style="color: rgb(64, 196, 255);background-color: rgba(64, 196, 255, .1);">
            <i class="nexmoefont icon-QQ"></i>
        </a><a class="mdui-ripple" href="mailto:785572731@qq.com" target="_blank" mdui-tooltip="{content: 'mail'}" style="color: rgb(249,8,8);background-color: rgba(249,8,8,.1);">
            <i class="nexmoefont icon-mail-fill"></i>
        </a><a class="mdui-ripple" href="https://www.bilibili.com/video/BV1g84y1p7dd/?vd_source=78fcea00bfe4e88e038af26d59ebc021" target="_blank" mdui-tooltip="{content: '哔哩哔哩'}" style="color: rgb(64, 196, 255);background-color: rgba(64, 196, 255, .1);">
            <i class="nexmoefont icon-bilibili"></i>
        </a>
    </div>
</div>
  
  

  
  
  <div class="nexmoe-widget-wrap">
    <div id="randomtagcloud" class="nexmoe-widget tagcloud nexmoe-rainbow">
      <a href="/tags/GameFramework%E6%A1%86%E6%9E%B6/" style="font-size: 20px;">GameFramework框架</a> <a href="/tags/%E5%8D%8E%E4%BD%97%E7%83%AD%E6%9B%B4%E6%96%B0/" style="font-size: 15px;">华佗热更新</a> <a href="/tags/%E7%BD%91%E6%A0%BC%E6%94%BE%E7%BD%AE%E7%B3%BB%E7%BB%9F/" style="font-size: 10px;">网格放置系统</a> <a href="/tags/%E8%A1%8C%E4%B8%9A%E8%A7%81%E8%A7%A3-%E5%BC%80%E7%AF%87%E5%8D%9A%E6%96%87/" style="font-size: 10px;">行业见解 开篇博文</a> <a href="/tags/%E9%9A%8F%E7%AC%94-Dictionary%E5%BA%95%E5%B1%82%E4%BB%A3%E7%A0%81%E5%89%96%E6%9E%90/" style="font-size: 10px;">随笔 Dictionary底层代码剖析</a> <a href="/tags/%E9%9A%8F%E7%AC%94-GC/" style="font-size: 10px;">随笔 GC</a> <a href="/tags/%E9%9A%8F%E7%AC%94-List%E5%BA%95%E5%B1%82%E4%BB%A3%E7%A0%81%E5%89%96%E6%9E%90/" style="font-size: 10px;">随笔 List底层代码剖析</a>
    </div>
    
  </div>

  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">Archive</h3>
    <div class="nexmoe-widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2045/">2045</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/">2023</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/">2022</a><span class="archive-list-count">3</span></li></ul>
    </div>
  </div>


<style>
.nexmoe-widget .archive-list-count{
	position : absolute;
	right: 15px;
	top:9px;
	color: #DDD;
}
</style>

  
</aside>
    <div class="nexmoe-copyright">
        &copy; 2023 色眯眯の流氓兔
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://github.com/tangyuxian/hexo-theme-tangyuxian" target="_blank">Tangyuxian</a><br/>
        <a href="http://beian.miit.gov.cn" target="_blank">辽ICP备2021002341号</a><br/>
        
        <div style="font-size: 12px">
            <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            本站总访问量  <a id="busuanzi_value_site_pv"></a> 次<br />
            本站访客数<a id="busuanzi_value_site_uv"></a>人次
        </div>
        
        
    </div>

</div><!-- .nexmoe-drawer -->

  </div>
  <div id="nexmoe-content">
    <div class="nexmoe-primary">
        <div class="nexmoe-post">
    
        <div class="nexmoe-post-cover"
             style="padding-bottom: 24.305555555555554%;">
            <img data-src="/images/background/bg_01.png" data-sizes="auto" alt="Dictionary底层源码剖析" class="lazyload">
            <h1>Dictionary底层源码剖析</h1>
        </div>
    

        <div class="nexmoe-post-meta nexmoe-rainbow" style="margin:10px 0!important;">
    <a><i class="nexmoefont icon-calendar-fill"></i>2022年05月03日</a>
    <a><i class="nexmoefont icon-areachart"></i>4.1k 字</a>
    <a><i class="nexmoefont icon-time-circle-fill"></i>大概 20 分钟</a>
</div>

        <div class="nexmoe-post-right">
            
        </div>

        <article>
            <blockquote>
<p>&emsp;&emsp;<font color=#1EB5DB size=4>Dictionary是C#中常用的数据结构之一，下面我们来对其进行底层源码的分析，看看常用的字典容器是如何构造的，它的优缺点如何。</font><span id="more"></span></p>
</blockquote>
<h1 id="–简介–"><a href="#–简介–" class="headerlink" title="–简介–"></a>–简介–</h1><p>&emsp;&emsp;我们知道，Dictionary字典型数据结构是以关键字key值和value值进行一一映射的。这种映射关系是通过Hash函数实现，Dictionary对每个key加入容器的运算都进行一次hash运算，从而找到自己的位置。比如一个整数88，最简单的就是一个余操作：hash_key &#x3D; key % 30 &#x3D; 28。但是对于实例对象和字符串来说，没有直接的数字作为hash标准，因此他们需要通过内存地址计算一个hash值，计算这个内存对象的函数就叫做hashcode。<br>&emsp;&emsp;对于不同的key，在hash计算时可能得到相同的hash地址，这种现象称为hash冲突，一般情况下，冲突只能尽可能少，不能完全避免。因为hash函数是从关键字范围到索引范围的映射，通常关键字范围要远大于索引范围，他的元素包括多个可能得关键字，如何解决hash冲突，也就成了构建hash表不得不解决的一个问题。<br>&emsp;&emsp;在处理hash冲突的方法中，通常有开放定址法、再hash法、链地址法、建立一个公共溢出区等。Dictionary使用的解决方法是拉链法，又称链地址法。</p>
<h2 id="链地址法："><a href="#链地址法：" class="headerlink" title="链地址法："></a>链地址法：</h2><p>&emsp;&emsp;将所有关键字为同义词的结点链接在同一个单链表中。若选定的散列表长度为n，则可将散列表定义为一个由n个头指针组成的指针数 组T[0..n-1]。凡是散列地址为i的结点，均插入到以T[i]为头指针的单链表中。T中各分量的初值均应为空指针。<br>&emsp;&emsp;在hash表上查找元素的过程和构建hash表的过程基本一直，给定Key值，根据造表时设定的哈希函数求得哈希地址，若表中此位置没有记录，则查找不成功；否则比较关键字，若何给定值相等，则查找成功；否则根据处理冲突的方法寻找“下一地址”，直到哈希表中某个位置为空或者表中所填记录的关键字等于给定值时为止。</p>
<h3 id="Hash冲突拉链法结构图："><a href="#Hash冲突拉链法结构图：" class="headerlink" title="Hash冲突拉链法结构图："></a>Hash冲突拉链法结构图：</h3><p><img data-fancybox="gallery" data-sizes="auto" data-src="/images/Dictionary%E5%89%96%E6%9E%90/%E6%8B%89%E9%93%BE%E6%B3%95%E7%BB%93%E6%9E%84%E5%9B%BE.png" alt="Dictionary剖析IMG" class="lazyload"></p>
<center>
拉链法结构图
</center>
&emsp;&emsp;如图所示，拉链法结构中，主要的宿主为数组指针，每个数组元素里存放着指向下一个节点的指针，如果没有元素在单元上，则为空指针。当多个元素都指向同一个单元格时，则以链表的形式依次存放并列的元素。

<h1 id="–Dictionary的接口–"><a href="#–Dictionary的接口–" class="headerlink" title="–Dictionary的接口–"></a>–Dictionary的接口–</h1><pre><code>public class Dictionary&lt;TKey, TValue&gt; : 
  IDictionary&lt;TKey, TValue&gt;,
  ICollection&lt;KeyValuePair&lt;TKey, TValue&gt;&gt;,
  IEnumerable&lt;KeyValuePair&lt;TKey, TValue&gt;&gt;,
  IEnumerable,
  IDictionary,
  ICollection,
  IReadOnlyDictionary&lt;TKey, TValue&gt;,
  IReadOnlyCollection&lt;KeyValuePair&lt;TKey, TValue&gt;&gt;,
  ISerializable,
  IDeserializationCallback
&#123;
  private int[] buckets;  //Hash桶
  private Dictionary&lt;TKey, TValue&gt;.Entry[] entries;  //Entry数组，存放元素
  private int count;  //当前entries的index位置
  private int version;  //当前版本，放置迭代过程中集合被更改
  private int freeList;  //被删除Entry在entries中的下标index，这个位置是空闲的
  private int freeCount;  //有多少个被删除的Entry，有多少个空闲位置
  private IEqualityComparer&lt;TKey&gt; comparer;  //比较器
  private Dictionary&lt;TKey, TValue&gt;.KeyCollection keys;  //存放key的集合
  private Dictionary&lt;TKey, TValue&gt;.ValueCollection values;  //存放value的集合
  private object _syncRoot;
  private const string VersionName = &quot;Version&quot;;
  private const string HashSizeName = &quot;HashSize&quot;;
  private const string KeyValuePairsName = &quot;KeyValuePairs&quot;;
  private const string ComparerName = &quot;Comparer&quot;;

  [__DynamicallyInvokable]
  public Dictionary()
    : this(0, (IEqualityComparer&lt;TKey&gt;) null)
  &#123;
  &#125;
</code></pre>
<pre><code>private struct Entry &#123;
    public int hashCode;    // Lower 31 bits of hash code, -1 if unused
    public int next;        // Index of next entry, -1 if last
    public TKey key;           // Key of entry
    public TValue value;         // Value of entry
&#125;
</code></pre>
<p>&emsp;&emsp;从继承的类和接口看，Dictionary 主要继承了 IDictionary 接口，和 ISerializable 接口。IDictionary 和 ISerializable 在使用过程中，其主要的接口为，Add, Remove, ContainsKey, Clear, TryGetValue, Keys, Values, 以及[]数组符号形式作为返回值的接口。也包括了常用库 Collection 中的接口，Count, Contains等。<br>&emsp;&emsp;从 Dictionary 的定义变量中可以看出，Dictionary 是以数组为底层数据结构的类。当我们实例化 new Dictionary() 后，内部的数组是0个数组的状态。与 List 组件一样，Dictionary 也是需要扩容的，会随着元素数量的增加而不断扩容。具体我们来看看下面的接口源码剖析。<br>&emsp;&emsp;下面的我们将围绕上述的接口进行解析 Dictionary 底层运作机制。</p>
<h2 id="1-Add接口"><a href="#1-Add接口" class="headerlink" title="1.	Add接口"></a>1.	Add接口</h2><pre><code>[__DynamicallyInvokable]
public void Add(TKey key, TValue value) =&gt; this.Insert(key, value, true);
</code></pre>
<pre><code class="private">&#123;
  int prime = HashHelpers.GetPrime(capacity);
  this.buckets = new int[prime];
  for (int index = 0; index &lt; this.buckets.Length; ++index)
    this.buckets[index] = -1;
  this.entries = new Dictionary&lt;TKey, TValue&gt;.Entry[prime];
  this.freeList = -1;
&#125;
</code></pre>
<pre><code class="private">&#123;
  if ((object) key == null)
    ThrowHelper.ThrowArgumentNullException(ExceptionArgument.key);
  if (this.buckets == null)
    this.Initialize(0);
  int num1 = this.comparer.GetHashCode(key) &amp; int.MaxValue;
  int index1 = num1 % this.buckets.Length;
  int num2 = 0;
  for (int index2 = this.buckets[index1]; index2 &gt;= 0; index2 = this.entries[index2].next)
  &#123;
    if (this.entries[index2].hashCode == num1 &amp;&amp; this.comparer.Equals(this.entries[index2].key, key))
    &#123;
      if (add)
        ThrowHelper.ThrowArgumentException(ExceptionResource.Argument_AddingDuplicate);
      this.entries[index2].value = value;
      ++this.version;
      return;
    &#125;
    ++num2;
  &#125;
  int index3;
  if (this.freeCount &gt; 0)
  &#123;
    index3 = this.freeList;
    this.freeList = this.entries[index3].next;
    --this.freeCount;
  &#125;
  else
  &#123;
    if (this.count == this.entries.Length)
    &#123;
      this.Resize();
      index1 = num1 % this.buckets.Length;
    &#125;
    index3 = this.count;
    ++this.count;
  &#125;
  this.entries[index3].hashCode = num1;
  this.entries[index3].next = this.buckets[index1];
  this.entries[index3].key = key;
  this.entries[index3].value = value;
  this.buckets[index1] = index3;
  ++this.version;
  if (num2 &lt;= 100 || !HashHelpers.IsWellKnownEqualityComparer((object) this.comparer))
    return;
  this.comparer = (IEqualityComparer&lt;TKey&gt;) HashHelpers.GetRandomizedEqualityComparer((object) this.comparer);
  this.Resize(this.entries.Length, true);
&#125;
</code></pre>
<p>&emsp;&emsp;其实 Add 接口就是 Insert 的代理，首先会构造数据结构，对桶buckets进行初始化。初始化需要多大的数组，从HashHelpers的源码中我们可以找到定义：</p>
<pre><code>public static readonly int[] primes = &#123;
    3, 7, 11, 17, 23, 29, 37, 47, 59, 71, 89, 107, 131, 163, 197, 239, 293, 353, 431, 521, 631, 761, 919,
    1103, 1327, 1597, 1931, 2333, 2801, 3371, 4049, 4861, 5839, 7013, 8419, 10103, 12143, 14591,
    17519, 21023, 25229, 30293, 36353, 43627, 52361, 62851, 75431, 90523, 108631, 130363, 156437,
    187751, 225307, 270371, 324449, 389357, 467237, 560689, 672827, 807403, 968897, 1162687, 1395263,
    1674319, 2009191, 2411033, 2893249, 3471899, 4166287, 4999559, 5999471, 7199369&#125;;

[ReliabilityContract(Consistency.WillNotCorruptState, Cer.Success)]
public static int GetPrime(int min) 
&#123;
    if (min &lt; 0)
        throw new ArgumentException(Environment.GetResourceString(&quot;Arg_HTCapacityOverflow&quot;));
    Contract.EndContractBlock();

    for (int i = 0; i &lt; primes.Length; i++) 
    &#123;
        int prime = primes[i];
        if (prime &gt;= min) return prime;
    &#125;

    //outside of our predefined table. 
    //compute the hard way. 
    for (int i = (min | 1); i &lt; Int32.MaxValue;i+=2) 
    &#123;
        if (IsPrime(i) &amp;&amp; ((i - 1) % Hashtable.HashPrime != 0))
            return i;
    &#125;
    return min;
&#125;
</code></pre>
<pre><code>// Returns size of hashtable to grow to.
public static int ExpandPrime(int oldSize)
&#123;
    int newSize = 2 * oldSize;

    // Allow the hashtables to grow to maximum possible size (~2G elements) before encoutering capacity overflow.
    // Note that this check works even when _items.Length overflowed thanks to the (uint) cast
    if ((uint)newSize &gt; MaxPrimeArrayLength &amp;&amp; MaxPrimeArrayLength &gt; oldSize)
    &#123;
        Contract.Assert( MaxPrimeArrayLength == GetPrime(MaxPrimeArrayLength), &quot;Invalid MaxPrimeArrayLength&quot;);
        return MaxPrimeArrayLength;
    &#125;

    return GetPrime(newSize);
&#125;
</code></pre>
<p>&emsp;&emsp;上述代码为 HashHelpers 部分的源码，其中 GetPrime 会返回一个需要的 size 最小的数值，从 GetPrime 函数的代码中，我们可以知道这个 size 是由数组 primes 里的值与当前需要的数量大小有关，当需要的数量小于 primes 某个单元格的数字时返回该数字，而 ExpandPrime 则更加简单粗暴，直接返回原来size的2倍作为扩展数量。<br>&emsp;&emsp;从Prime的定义看的出，首次定义size为3，每次扩大2倍，也就是，3-&gt;7-&gt;17-&gt;37-&gt;…. 底层数据结构的大小是按照这个数值顺序来扩展的，除非你在创建 Dictionary 时，先定义了他的初始大小，指定的初始大小也会先被 GetPrime 计算该分配的数量最终得到应该分配的数组大小。这和 List 组件的分配方式一模一样。<br>&emsp;&emsp;我们继续看初始化后的内容，对关键字 Key 做Hash哈希操作从而获得地址索引:</p>
<pre><code>int hashCode = comparer.GetHashCode(key) &amp; 0x7FFFFFFF;
int targetBucket = hashCode % buckets.Length;
</code></pre>
<p>&emsp;&emsp;当调用函数获得Hash哈希值后，还需要对哈希地址做余操作，以确定地址落在 Dictionary 数组长度范围内不会溢出。<br>&emsp;&emsp;紧接着对指定数组单元格内的链表元素做遍历操作，找出空出来的位置将值填入。</p>
<pre><code>for (int i = buckets[targetBucket]; i &gt;= 0; i = entries[i].next) &#123;
        if (entries[i].hashCode == hashCode &amp;&amp; comparer.Equals(entries[i].key, key))
        &#123;
            if (add)
            &#123;
                ThrowHelper.ThrowArgumentException(ExceptionResource.Argument_AddingDuplicate);
            &#125;

            entries[i].value = value;
            version++;
            return;
        &#125;

#if FEATURE_RANDOMIZED_STRING_HASHING
    collisionCount++;
#endif
    &#125;
</code></pre>
<p>&emsp;&emsp;这一步就是前面我们所说的拉链法的链表推入动作。当获得Hash值的数组索引后，我们知道了该将数据存放在哪个数组位置上，如果该位置已经有元素被推入，则需要将其推入到链表的尾部。从for循环开始，检查是否到达链表的末尾，最后将数据放入尾部，并结束函数。<br>&emsp;&emsp;如果数组的空间不够了怎么办？源码中体现了这一点:</p>
<pre><code>int index;
if (freeCount &gt; 0)
&#123;
    index = freeList;
    freeList = entries[index].next;
    freeCount--;
&#125;

else
&#123;
    if (count == entries.Length)
    &#123;
        Resize();
        targetBucket = hashCode % buckets.Length;
    &#125;

    index = count;
    count++;
&#125;

entries[index].hashCode = hashCode;
entries[index].next = buckets[targetBucket];
entries[index].key = key;
entries[index].value = value;
buckets[targetBucket] = index;
</code></pre>
<p>&emsp;&emsp;当被用来记录剩余单元格数量的变量 freeCount 等于0时，则进行扩容，扩容后的大小就是我们前面提到的 调用 ExpandPrime 后的数量，即通常情况下为原来的2倍，再根据这个空间大小数字调用 GetPrime 来得到真正的新数组的大小。</p>
<h2 id="2-Remove接口"><a href="#2-Remove接口" class="headerlink" title="2.	Remove接口"></a>2.	Remove接口</h2><pre><code>[__DynamicallyInvokable]
public bool Remove(TKey key)
&#123;
  if ((object) key == null)
    ThrowHelper.ThrowArgumentNullException(ExceptionArgument.key);
  if (this.buckets != null)
  &#123;
    int num = this.comparer.GetHashCode(key) &amp; int.MaxValue;
    int index1 = num % this.buckets.Length;
    int index2 = -1;
    for (int index3 = this.buckets[index1]; index3 &gt;= 0; index3 = this.entries[index3].next)
    &#123;
      if (this.entries[index3].hashCode == num &amp;&amp; this.comparer.Equals(this.entries[index3].key, key))
      &#123;
        if (index2 &lt; 0)
          this.buckets[index1] = this.entries[index3].next;
        else
          this.entries[index2].next = this.entries[index3].next;
        this.entries[index3].hashCode = -1;
        this.entries[index3].next = this.freeList;
        this.entries[index3].key = default (TKey);
        this.entries[index3].value = default (TValue);
        this.freeList = index3;
        ++this.freeCount;
        ++this.version;
        return true;
      &#125;
      index2 = index3;
    &#125;
  &#125;
  return false;
&#125;
</code></pre>
<p>&emsp;&emsp;删除的过程和插入的过程比较相似，因为要查找到Key元素所在位置，所以再次将Key值做哈希操作也是难免的，然后类似沿着拉链法的模式寻找与关键字匹配的元素。<br>&emsp;&emsp;我们注意到 Remove 接口相对 Add 接口简单的多，同样用哈希函数 comparer.GetHashCode 再除余后得到范围内的地址索引，再做余操作确定地址落在数组范围内，从哈希索引地址开始，查找冲突的元素的Key是否与需要移除的Key值相同，相同则进行移除操作并退出。<br>&emsp;&emsp;注意源码中，Remove 的移除操作并没有对内存进行删减，而只是将其单元格置空，这是为了减少了内存的频繁操作。</p>
<h2 id="3-ContainsKey接口"><a href="#3-ContainsKey接口" class="headerlink" title="3.	ContainsKey接口"></a>3.	ContainsKey接口</h2><pre><code>[__DynamicallyInvokable]
public bool ContainsKey(TKey key) =&gt; this.FindEntry(key) &gt;= 0;
</code></pre>
<pre><code>private int FindEntry(TKey key)
&#123;
  if ((object) key == null)
    ThrowHelper.ThrowArgumentNullException(ExceptionArgument.key);
  if (this.buckets != null)
  &#123;
    int num = this.comparer.GetHashCode(key) &amp; int.MaxValue;
    for (int entry = this.buckets[num % this.buckets.Length]; entry &gt;= 0; entry = this.entries[entry].next)
    &#123;
      if (this.entries[entry].hashCode == num &amp;&amp; this.comparer.Equals(this.entries[entry].key, key))
        return entry;
    &#125;
  &#125;
  return -1;
&#125;
</code></pre>
<p>&emsp;&emsp;从源码中看到 ContainsKey 是一个查找Key位置的过程。它调用了 FindEntry 函数，FindEntry 查找Key值位置的方法跟我们前面提到的相同。从用Key值得到的哈希值地址开始查找，查看所有冲突链表中，是否有与Key值相同的值，找到即刻返回该索引地址。</p>
<h2 id="4-TryGetValue接口"><a href="#4-TryGetValue接口" class="headerlink" title="4.	TryGetValue接口"></a>4.	TryGetValue接口</h2><pre><code>[__DynamicallyInvokable]
public bool TryGetValue(TKey key, out TValue value)
&#123;
  int entry = this.FindEntry(key);
  if (entry &gt;= 0)
  &#123;
    value = this.entries[entry].value;
    return true;
  &#125;
  value = default (TValue);
  return false;
&#125;
</code></pre>
<p>&emsp;&emsp;与 ContainsKey 同样，他调用的也是FindEntry的接口，来获取Key对应的Value值。</p>
<h2 id="5-【】接口"><a href="#5-【】接口" class="headerlink" title="5.【】接口"></a>5.【】接口</h2><pre><code>[__DynamicallyInvokable]
public TValue this[TKey key]
&#123;
  [__DynamicallyInvokable] get
  &#123;
    int entry = this.FindEntry(key);
    if (entry &gt;= 0)
      return this.entries[entry].value;
    ThrowHelper.ThrowKeyNotFoundException();
    return default (TValue);
  &#125;
  [__DynamicallyInvokable] set =&gt; this.Insert(key, value, false);
&#125;
</code></pre>
<p>&emsp;&emsp;在重新定义[]符号的代码中，获取元素时也同样使用 FindEntry 函数，而 Set 设置元素时则使用与 Add 调用相同的 Insert函数，它们都是同一套方法，即哈希拉链冲突解决方案。</p>
<h2 id="Hash函数的创建过程"><a href="#Hash函数的创建过程" class="headerlink" title="Hash函数的创建过程"></a>Hash函数的创建过程</h2><p>&emsp;&emsp;从源码剖析来看，哈希冲突的拉链法贯穿了整个底层数据结构。因此哈希函数是关键了，哈希函数的好坏直接决定了效率高低。<br>&emsp;&emsp;既然这么重要，我们来看看哈希函数的创建过程，比较函数的创建的源码：</p>
<pre><code>private static EqualityComparer&lt;T&gt; CreateComparer()
&#123;
    Contract.Ensures(Contract.Result&lt;EqualityComparer&lt;T&gt;&gt;() != null);
 
    RuntimeType t = (RuntimeType)typeof(T);
    // Specialize type byte for performance reasons
    if (t == typeof(byte)) &#123;
        return (EqualityComparer&lt;T&gt;)(object)(new ByteEqualityComparer());
    &#125;
    // If T implements IEquatable&lt;T&gt; return a GenericEqualityComparer&lt;T&gt;
    if (typeof(IEquatable&lt;T&gt;).IsAssignableFrom(t)) &#123;
        return (EqualityComparer&lt;T&gt;)RuntimeTypeHandle.CreateInstanceForAnotherGenericParameter((RuntimeType)typeof(GenericEqualityComparer&lt;int&gt;), t);
    &#125;
    // If T is a Nullable&lt;U&gt; where U implements IEquatable&lt;U&gt; return a NullableEqualityComparer&lt;U&gt;
    if (t.IsGenericType &amp;&amp; t.GetGenericTypeDefinition() == typeof(Nullable&lt;&gt;)) &#123;
        RuntimeType u = (RuntimeType)t.GetGenericArguments()[0];
        if (typeof(IEquatable&lt;&gt;).MakeGenericType(u).IsAssignableFrom(u)) &#123;
            return (EqualityComparer&lt;T&gt;)RuntimeTypeHandle.CreateInstanceForAnotherGenericParameter((RuntimeType)typeof(NullableEqualityComparer&lt;int&gt;), u);
        &#125;
    &#125;
    
    // See the METHOD__JIT_HELPERS__UNSAFE_ENUM_CAST and METHOD__JIT_HELPERS__UNSAFE_ENUM_CAST_LONG cases in getILIntrinsicImplementation
    if (t.IsEnum) &#123;
        TypeCode underlyingTypeCode = Type.GetTypeCode(Enum.GetUnderlyingType(t));
 
        // Depending on the enum type, we need to special case the comparers so that we avoid boxing
        // Note: We have different comparers for Short and SByte because for those types we need to make sure we call GetHashCode on the actual underlying type as the 
        // implementation of GetHashCode is more complex than for the other types.
        switch (underlyingTypeCode) &#123;
            case TypeCode.Int16: // short
                return (EqualityComparer&lt;T&gt;)RuntimeTypeHandle.CreateInstanceForAnotherGenericParameter((RuntimeType)typeof(ShortEnumEqualityComparer&lt;short&gt;), t);
            case TypeCode.SByte:
                return (EqualityComparer&lt;T&gt;)RuntimeTypeHandle.CreateInstanceForAnotherGenericParameter((RuntimeType)typeof(SByteEnumEqualityComparer&lt;sbyte&gt;), t);
            case TypeCode.Int32:
            case TypeCode.UInt32:
            case TypeCode.Byte:
            case TypeCode.UInt16: //ushort
                return (EqualityComparer&lt;T&gt;)RuntimeTypeHandle.CreateInstanceForAnotherGenericParameter((RuntimeType)typeof(EnumEqualityComparer&lt;int&gt;), t);
            case TypeCode.Int64:
            case TypeCode.UInt64:
                return (EqualityComparer&lt;T&gt;)RuntimeTypeHandle.CreateInstanceForAnotherGenericParameter((RuntimeType)typeof(LongEnumEqualityComparer&lt;long&gt;), t);
        &#125;
    &#125;
    // Otherwise return an ObjectEqualityComparer&lt;T&gt;
    return new ObjectEqualityComparer&lt;T&gt;();
&#125;
</code></pre>
<p>&emsp;&emsp;我们看到源码中，对数字，byte，有‘比较’接口(IEquatable<T>)，和没有‘比较’接口，四种方式进行了区分对待。<br>&emsp;&emsp;对于像数字和byte类的，比较容易比较，所以它们都是一类，且是有相应固定的比较函数的。而有‘比较’接口(IEquatable<T>)的实体，则直接使用GenericEqualityComparer<T>来获得哈希函数。最后那些没有‘比较’接口(IEquatable)的实体，如果继承了 Nullable&lt;U&gt; 接口，则使用一个叫 NullableEqualityComparer 的比较函数来代替。如果什么都不是，就只能使用 ObjectEqualityComparer&lt;T&gt; 默认的对象比较方式来做比较了。<br>&emsp;&emsp;在C#里所有类都继承了 Object 类，所以即使没有特别的重写 Equals 函数，都会使用 Object 类的 Equals 函数:</p>
<pre><code class="public">&#123;
    return RuntimeHelpers.Equals(this, obj);
&#125;

[System.Security.SecuritySafeCritical]  // auto-generated
[ResourceExposure(ResourceScope.None)]
[MethodImplAttribute(MethodImplOptions.InternalCall)]
public new static extern bool Equals(Object o1, Object o2);
</code></pre>
<p>&emsp;&emsp;而这个 Equals 两个对象的比较，是以内存地址为基准的。<br>&emsp;&emsp;Dictionary 同List一样并不是线程安全的组件，官方源码中进行了这样的解释。</p>
<blockquote>
<p>** Hashtable has multiple reader&#x2F;single writer (MR&#x2F;SW) thread safety built into<br>** certain methods and properties, whereas Dictionary doesn’t. If you’re<br>** converting framework code that formerly used Hashtable to Dictionary, it’s<br>** important to consider whether callers may have taken a dependence on MR&#x2F;SW<br>** thread safety. If a reader writer lock is available, then that may be used<br>** with a Dictionary to get the same thread safety guarantee.</p>
</blockquote>
<p>&emsp;&emsp;Hashtable在多线程读写中是线程安全的，而 Dictionary 不是。如果要在多个线程中共享Dictionaray的读写操作，就要自己写lock以保证线程安全。<br>&emsp;&emsp;到这里我们已经全面了解了 Dictionary 的内部构造和运作机制。他是由数组构成，并且由哈希函数完成地址构建，由拉链法冲突解决方式来解决冲突。<br>&emsp;&emsp;从效率上看，同List一样最好在 实例化对象时，即 new 时尽量确定大致数量会更加高效，另外用数值方式做Key比用类实例方式作为Key值更加高效率。<br>&emsp;&emsp;从内存操作上看，大小以3-&gt;7-&gt;17-&gt;37-&gt;….的速度，每次增加2倍多的顺序进行，删除时，并不缩减内存。<br>&emsp;&emsp;如果想在多线程中，共享 Dictionary 则需要进行我们自己进行lock操作。</p>

        </article>

        
            
  <div class="nexmoe-post-copyright">
    <strong>Author：</strong>色眯眯の流氓兔<br>
    
    <strong>Link：</strong><a href="https://loveviolet.github.io/2022/05/03/Dictionary%E5%BA%95%E5%B1%82%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" title="https:&#x2F;&#x2F;loveviolet.github.io&#x2F;2022&#x2F;05&#x2F;03&#x2F;Dictionary%E5%BA%95%E5%B1%82%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90&#x2F;" target="_blank" rel="noopener">https:&#x2F;&#x2F;loveviolet.github.io&#x2F;2022&#x2F;05&#x2F;03&#x2F;Dictionary%E5%BA%95%E5%B1%82%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90&#x2F;</a><br>

    
      <strong>版权声明：</strong>本文采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/cn/deed.zh" target="_blank">CC BY-NC-SA 3.0 CN</a> 协议进行许可
    
  </div>


        

        <div class="nexmoe-post-meta nexmoe-rainbow">
    
    
        <a class="nexmoefont icon-tag-fill -none-link" href="/tags/%E9%9A%8F%E7%AC%94-Dictionary%E5%BA%95%E5%B1%82%E4%BB%A3%E7%A0%81%E5%89%96%E6%9E%90/" rel="tag">随笔 Dictionary底层代码剖析</a>
    
</div>

    <div class="nexmoe-post-footer">
        <section class="nexmoe-comment">
    <div class="valine"></div>
<script src='https://lib.baomitu.com/valine/1.3.9/Valine.min.js'></script>
<script>
    // 使用方法 https://valine.js.org/quickstart.html
    new Valine({
        el: '.valine',
        appId: 'r5zxC0st0DDjPA9auXzMV7HY-gzGzoHsz',
        appKey: '3bqCsovpyfTPHUzTHovd3V3V'
    })
</script>
</section>
    </div>
</div>


        <div class="nexmoe-post-right">
          
            <div class="nexmoe-fixed">
              <div class="nexmoe-tool">
                <a href="#" aria-label="回到顶部" title="top"><button class="mdui-fab mdui-ripple"><i class="nexmoefont icon-caret-top"></i></button></a>
              </div>
            </div>
          
        </div>
    </div>
  </div>
  <div id="nexmoe-pendant">
    <div class="nexmoe-drawer mdui-drawer nexmoe-pd" id="drawer">
        
            <div class="nexmoe-pd-item">
                <div class="clock">
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="needle" id="hours"></div>
        <div class="needle" id="minutes"></div>
        <div class="needle" id="seconds"></div>
        <div class="clock_logo">

        </div>

    </div>
<style>
    .clock {
        background-color: #ffffff;
        width: 70vw;
        height: 70vw;
        max-width: 70vh;
        max-height: 70vh;
        border: solid 2.8vw #242424;
        position: relative;
        overflow: hidden;
        border-radius: 50%;
        box-sizing: border-box;
        box-shadow: 0 1.4vw 2.8vw rgba(0, 0, 0, 0.8);
        zoom:0.2
    }

    .memory {
        position: absolute;
        top: 50%;
        left: 50%;
        transform-origin: center;
    }

    .memory:nth-child(1) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(0deg) translateY(-520%);
    }

    .memory:nth-child(2) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(6deg) translateY(-1461%);
    }

    .memory:nth-child(3) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(12deg) translateY(-1461%);
    }

    .memory:nth-child(4) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(18deg) translateY(-1461%);
    }

    .memory:nth-child(5) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(24deg) translateY(-1461%);
    }

    .memory:nth-child(6) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(30deg) translateY(-520%);
    }

    .memory:nth-child(7) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(36deg) translateY(-1461%);
    }

    .memory:nth-child(8) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(42deg) translateY(-1461%);
    }

    .memory:nth-child(9) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(48deg) translateY(-1461%);
    }

    .memory:nth-child(10) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(54deg) translateY(-1461%);
    }

    .memory:nth-child(11) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(60deg) translateY(-520%);
    }

    .memory:nth-child(12) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(66deg) translateY(-1461%);
    }

    .memory:nth-child(13) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(72deg) translateY(-1461%);
    }

    .memory:nth-child(14) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(78deg) translateY(-1461%);
    }

    .memory:nth-child(15) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(84deg) translateY(-1461%);
    }

    .memory:nth-child(16) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(90deg) translateY(-520%);
    }

    .memory:nth-child(17) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(96deg) translateY(-1461%);
    }

    .memory:nth-child(18) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(102deg) translateY(-1461%);
    }

    .memory:nth-child(19) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(108deg) translateY(-1461%);
    }

    .memory:nth-child(20) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(114deg) translateY(-1461%);
    }

    .memory:nth-child(21) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(120deg) translateY(-520%);
    }

    .memory:nth-child(22) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(126deg) translateY(-1461%);
    }

    .memory:nth-child(23) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(132deg) translateY(-1461%);
    }

    .memory:nth-child(24) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(138deg) translateY(-1461%);
    }

    .memory:nth-child(25) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(144deg) translateY(-1461%);
    }

    .memory:nth-child(26) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(150deg) translateY(-520%);
    }

    .memory:nth-child(27) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(156deg) translateY(-1461%);
    }

    .memory:nth-child(28) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(162deg) translateY(-1461%);
    }

    .memory:nth-child(29) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(168deg) translateY(-1461%);
    }

    .memory:nth-child(30) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(174deg) translateY(-1461%);
    }

    .memory:nth-child(31) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(180deg) translateY(-520%);
    }

    .memory:nth-child(32) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(186deg) translateY(-1461%);
    }

    .memory:nth-child(33) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(192deg) translateY(-1461%);
    }

    .memory:nth-child(34) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(198deg) translateY(-1461%);
    }

    .memory:nth-child(35) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(204deg) translateY(-1461%);
    }

    .memory:nth-child(36) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(210deg) translateY(-520%);
    }

    .memory:nth-child(37) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(216deg) translateY(-1461%);
    }

    .memory:nth-child(38) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(222deg) translateY(-1461%);
    }

    .memory:nth-child(39) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(228deg) translateY(-1461%);
    }

    .memory:nth-child(40) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(234deg) translateY(-1461%);
    }

    .memory:nth-child(41) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(240deg) translateY(-520%);
    }

    .memory:nth-child(42) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(246deg) translateY(-1461%);
    }

    .memory:nth-child(43) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(252deg) translateY(-1461%);
    }

    .memory:nth-child(44) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(258deg) translateY(-1461%);
    }

    .memory:nth-child(45) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(264deg) translateY(-1461%);
    }

    .memory:nth-child(46) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(270deg) translateY(-520%);
    }

    .memory:nth-child(47) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(276deg) translateY(-1461%);
    }

    .memory:nth-child(48) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(282deg) translateY(-1461%);
    }

    .memory:nth-child(49) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(288deg) translateY(-1461%);
    }

    .memory:nth-child(50) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(294deg) translateY(-1461%);
    }

    .memory:nth-child(51) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(300deg) translateY(-520%);
    }

    .memory:nth-child(52) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(306deg) translateY(-1461%);
    }

    .memory:nth-child(53) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(312deg) translateY(-1461%);
    }

    .memory:nth-child(54) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(318deg) translateY(-1461%);
    }

    .memory:nth-child(55) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(324deg) translateY(-1461%);
    }

    .memory:nth-child(56) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(330deg) translateY(-520%);
    }

    .memory:nth-child(57) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(336deg) translateY(-1461%);
    }

    .memory:nth-child(58) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(342deg) translateY(-1461%);
    }

    .memory:nth-child(59) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(348deg) translateY(-1461%);
    }

    .memory:nth-child(60) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(354deg) translateY(-1461%);
    }

    .needle {
        position: absolute;
        top: 50%;
        left: 50%;
        transform-origin: center;
    }

    .needle#hours {
        background-color: #1f1f1f;
        width: 4%;
        height: 30%;
        transform-origin: center 75%;
        transform: translate(-50%, -75%);
    }

    .needle#hours.moving {
        transition: transform 150ms ease-out;
    }

    .needle#hours:after {
        content: '';
        background-color: #1f1f1f;
        width: 4vw;
        height: 4vw;
        max-width: 4vh;
        max-height: 4vh;
        display: block;
        position: absolute;
        top: 75%;
        left: 50%;
        box-sizing: border-box;
        border-radius: 50%;
        transform: translate(-50%, -50%);
    }

    .needle#minutes {
        background-color: #1f1f1f;
        width: 2%;
        height: 45%;
        transform-origin: center 75%;
        transform: translate(-50%, -75%);
    }

    .needle#minutes.moving {
        transition: transform 150ms ease-out;
    }

    .needle#minutes:after {
        content: '';
        background-color: #1f1f1f;
        width: 4vw;
        height: 4vw;
        max-width: 4vh;
        max-height: 4vh;
        display: block;
        position: absolute;
        top: 75%;
        left: 50%;
        box-sizing: border-box;
        border-radius: 50%;
        transform: translate(-50%, -50%);
    }

    .needle#seconds {
        background-color: #cb2f2f;
        width: 1%;
        height: 50%;
        transform-origin: center 75%;
        transform: translate(-50%, -75%);
    }

    .needle#seconds.moving {
        transition: transform 150ms ease-out;
    }

    .needle#seconds:after {
        content: '';
        background-color: #cb2f2f;
        width: 2.5vw;
        height: 2.5vw;
        max-width: 2.5vh;
        max-height: 2.5vh;
        display: block;
        position: absolute;
        top: 75%;
        left: 50%;
        box-sizing: border-box;
        border-radius: 50%;
        transform: translate(-50%, -50%);
    }
    .clock_logo{
        width: 10vw;
        height: 10vw;
        max-width: 10vh;
        max-height: 10vh;
        position: absolute;
        top: 50%;
        left: 50%;
        box-sizing: border-box;
        border-radius: 50%;
        transform: translate(-50%, -50%);
        background-size: 100% 100%;
        background-repeat: no-repeat;
    }
    @media (min-width: 100vh) {
        .clock {
            border: solid 2.8vh #242424;
            box-shadow: 0 1.4vh 2.8vh rgba(0, 0, 0, 0.8);
        }
    }

</style>





            </div>
        
            <div class="nexmoe-pd-item">
                <div class="qweather" >
    <div id="he-plugin-standard"></div>
    <div class="qweather-logo">

    </div>

</div>
<style>
    .qweather{
        position: relative;
    }
    .qweather-logo{
        position: absolute;
        right: 0;
        top: -15px;
        width: 40px;
        height: 40px;
        background-size: 100% 100%;
        background-repeat: no-repeat;
    }
</style>
<script>
  WIDGET = {
    "CONFIG": {
      "layout": "2",
      "width": "260",
      "height": "220",
      "background": "5",
      "dataColor": "e67249",
      "borderRadius": "15",
      "key": "f74d1e1690e6432d801e97fa2f05a162"
    }
  }
</script>
<script src="https://widget.qweather.net/standard/static/js/he-standard-common.js?v=2.0"></script>

            </div>
        
</div>
<style>
    .nexmoe-pd {
        left: auto;
        top: 40px;
        right: 0;
    }
    .nexmoe-pd-item{
       display: flex;
        justify-content: center;
        margin-bottom: 30px;
    }
</style>

  </div>
  <script src="https://lib.baomitu.com/lazysizes/5.1.0/lazysizes.min.js"></script>
<script src="https://lib.baomitu.com/highlight.js/10.0.0/highlight.min.js"></script>
<script src="https://lib.baomitu.com/mdui/0.4.3/js/mdui.min.js"></script>

<script>
	hljs.initHighlightingOnLoad();
</script>

<script src="https://lib.baomitu.com/jquery/3.5.1/jquery.slim.min.js"></script>
<script src="/lib/fancybox/js/jquery.fancybox.min.js"></script>


<script src="/js/app.js?v=1702547675475"></script>

<script src="https://lib.baomitu.com/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>
<script>
	$(".justified-gallery").justifiedGallery({
		rowHeight: 160,
		margins: 10,
	});
</script>

  





<!-- hexo injector body_end start -->
<script src="/js/clock.js"></script>

<script src="https://lib.baomitu.com/clipboard.js/2.0.8/clipboard.min.js"></script>

<script src="/lib/codeBlock/codeBlockFuction.js"></script>

<script src="/lib/codeBlock/codeLang.js"></script>

<script src="/lib/codeBlock/codeCopy.js"></script>

<script src="/lib/codeBlock/codeShrink.js"></script>

<link rel="stylesheet" href="/lib/codeBlock/matery.css">

<script src="/js/webapp.js"></script>

<script src="https://code.jquery.com/jquery-3.6.0.js"></script>

<script src="/js/search.js"></script>
<!-- hexo injector body_end end --></body>
</html>

